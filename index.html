<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock's Coins</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .loading-spinner {
        border-top-color: #3498db;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
      }
      @-webkit-keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="root">
        <!-- The entire application UI will be rendered here by JavaScript -->
        <div class="flex items-center justify-center h-screen bg-gray-100">
          <div class="w-16 h-16 border-4 border-gray-300 border-solid rounded-full loading-spinner"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const firebaseConfig = { 
          apiKey: "AIzaSyDxc5KjPweb1jnj5ac64DspIFDKjEWwGzE", 
          authDomain: "rockscoins-369e0.firebaseapp.com", 
          projectId: "rockscoins-369e0", 
          storageBucket: "rockscoins-369e0.firebasestorage.app", 
          messagingSenderId: "133605397287", 
          appId: "1:133605397287:web:cf6170c9dac17eedb54f02", 
          measurementId: "G-JTJGZYYSFY" 
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Global State ---
        const state = {
            auth: null,
            db: null,
            user: null,
            products: [],
            checkoutStep: 0, // 0: Shop, 1: Details, 2: Checkout Form, 3: Confirmation
            selectedProduct: null,
            cart: [],
            shippingInfo: {
                name: '',
                email: '',
                address: ''
            },
            ADMIN_ID: 'rBvfZTUEg3PNQ0tr8wTdlmBFuXl2',
        };

        const root = document.getElementById('root');

        // --- Core UI Rendering Logic ---
        function renderApp() {
            // Check if Firebase is initialized and user state is determined
            if (!state.auth || !state.db) {
                root.innerHTML = `
                    <div class="flex items-center justify-center h-screen bg-gray-100">
                        <div class="w-16 h-16 border-4 border-gray-300 border-solid rounded-full loading-spinner"></div>
                    </div>
                `;
                return;
            }

            const isAdmin = state.user && state.user.uid === state.ADMIN_ID;
            
            let content;
            if (isAdmin) {
                content = renderAdminPanel();
            } else {
                content = renderShop();
            }
            
            root.innerHTML = `
                ${renderHeader()}
                <main class="py-10">
                    ${content}
                </main>
            `;
            
            // Re-attach event listeners after rendering
            attachEventListeners();
        }

        // --- Component Rendering Functions ---
        function renderHeader() {
            const userDisplay = state.user ? `
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium">Hello, ${state.user.displayName || 'User'}!</span>
                    <button id="sign-out-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                        Sign Out
                    </button>
                </div>
            ` : `
                <button id="sign-in-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                    Sign In with Google
                </button>
            `;

            return `
                <header class="bg-gray-900 text-white p-4 shadow-lg sticky top-0 z-50">
                    <div class="container mx-auto flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-yellow-400">Rock's Coins</h1>
                        <nav>
                            ${userDisplay}
                        </nav>
                    </div>
                </header>
            `;
        }

        function renderShop() {
            if (state.checkoutStep === 3) {
                return renderConfirmationModal();
            }

            if (state.checkoutStep === 2 && state.cart.length > 0) {
                return renderCheckoutForm();
            }
            
            if (state.checkoutStep === 1 && state.selectedProduct) {
                return renderProductDetails();
            }

            // Main shop view (checkoutStep 0)
            const productListHtml = state.products.map(product => `
                <div class="bg-white rounded-xl shadow-2xl overflow-hidden transform hover:scale-105 transition duration-300 ease-in-out">
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover" />
                    <div class="p-6">
                        <h3 class="text-2xl font-semibold text-gray-900">${product.name}</h3>
                        <p class="text-lg text-yellow-600 font-bold my-2">$${product.price.toFixed(2)}</p>
                        <p class="text-gray-600 mb-4 line-clamp-3">${product.description}</p>
                        <button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-full transition duration-300 ease-in-out view-details-btn" data-product-id="${product.id}">
                            View Details
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="container mx-auto p-8">
                    <h2 class="text-4xl font-bold text-center text-gray-800 mb-8">Our Coins</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${productListHtml}
                    </div>
                </div>
            `;
        }

        function renderAdminPanel() {
            const productListHtml = state.products.map(product => `
                <li class="flex flex-col md:flex-row items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm">
                    <div class="flex-1 text-gray-700">
                        <p class="font-bold text-lg">${product.name} - $${product.price.toFixed(2)}</p>
                        <p class="text-sm">${product.description}</p>
                        <p class="text-xs ${product.isAvailable ? 'text-green-600' : 'text-red-600'}">
                            ${product.isAvailable ? 'Available' : 'Dismissed'}
                        </p>
                    </div>
                    <div class="flex space-x-2 mt-4 md:mt-0">
                        <button class="py-2 px-4 rounded-full text-white font-bold transition duration-300 ease-in-out transform hover:scale-105 dismiss-product-btn ${product.isAvailable ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600'}" data-product-id="${product.id}" data-is-available="${product.isAvailable}">
                            ${product.isAvailable ? 'Dismiss' : 'Restore'}
                        </button>
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 delete-product-btn" data-product-id="${product.id}">
                            Delete
                        </button>
                    </div>
                </li>
            `).join('');

            return `
                <div class="container mx-auto p-8">
                    <h2 class="text-4xl font-bold text-center text-gray-800 mb-8">Admin Panel</h2>
                    <p class="text-center text-gray-600 mb-8">User ID: <span class="font-mono bg-gray-200 rounded p-1">${state.user?.uid || 'N/A'}</span></p>

                    <div class="bg-white p-6 rounded-xl shadow-2xl mb-8">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Add New Product</h3>
                        <form id="add-product-form" class="space-y-4">
                            <input type="text" id="product-name" placeholder="Product Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                            <textarea id="product-description" placeholder="Product Description" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required></textarea>
                            <input type="number" id="product-price" placeholder="Price" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.01" required />
                            <input type="url" id="product-image-url" placeholder="Image URL" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                                Add Product
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-2xl">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">Manage Products</h3>
                        <ul class="space-y-4">
                            ${productListHtml}
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderProductDetails() {
            const product = state.selectedProduct;
            return `
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8">
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full md:w-1/2 h-96 object-cover rounded-lg shadow-md" />
                        <div class="flex-1">
                            <h2 class="text-4xl font-bold text-gray-800">${product.name}</h2>
                            <p class="text-2xl text-yellow-600 font-bold my-4">$${product.price.toFixed(2)}</p>
                            <p class="text-gray-700 mb-6">${product.description}</p>
                            <button id="add-to-cart-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-full transition duration-300 ease-in-out">
                                Add to Cart
                            </button>
                            <button id="back-to-shop-btn" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-full transition duration-300 ease-in-out">
                                Back to Shop
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCheckoutForm() {
            const cartItemsHtml = state.cart.map((item, index) => `
                <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <span class="font-semibold text-gray-700">${item.name}</span>
                    <span class="text-yellow-600 font-bold">$${item.price.toFixed(2)}</span>
                </li>
            `).join('');
            const total = state.cart.reduce((sum, item) => sum + item.price, 0).toFixed(2);

            return `
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Checkout</h2>
                    <ul class="mb-6 space-y-2">
                        ${cartItemsHtml}
                        <li class="flex justify-between items-center border-t-2 border-gray-200 mt-4 pt-4">
                            <span class="font-bold text-lg text-gray-800">Total:</span>
                            <span class="font-bold text-lg text-yellow-600">$${total}</span>
                        </li>
                    </ul>
                    <form id="checkout-form" class="space-y-4">
                        <input type="text" id="shipping-name" placeholder="Full Name" value="${state.shippingInfo.name}" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        <input type="email" id="shipping-email" placeholder="Email Address" value="${state.shippingInfo.email}" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        <textarea id="shipping-address" placeholder="Shipping Address" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required>${state.shippingInfo.address}</textarea>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                            Confirm Order
                        </button>
                        <button type="button" id="back-to-shop-btn-2" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                            Back to Shop
                        </button>
                    </form>
                </div>
            `;
        }

        function renderConfirmationModal() {
            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-2xl p-8 shadow-2xl max-w-md w-full text-center">
                        <h3 class="text-3xl font-bold text-green-600 mb-4">Order Confirmed!</h3>
                        <p class="text-gray-700 mb-6">Thank you, <span class="font-semibold">${state.shippingInfo.name}</span>, for your purchase.</p>
                        <div class="text-left text-sm text-gray-600 mb-6 bg-gray-100 p-4 rounded-lg">
                            <p><strong>Shipping to:</strong></p>
                            <p>${state.shippingInfo.name}</p>
                            <p>${state.shippingInfo.address}</p>
                            <p>${state.shippingInfo.email}</p>
                        </div>
                        <button id="continue-shopping-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out transform hover:scale-105">
                            Continue Shopping
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Event Listeners and Handlers ---
        function attachEventListeners() {
            // Header buttons
            const signInBtn = document.getElementById('sign-in-btn');
            if (signInBtn) signInBtn.onclick = handleGoogleSignIn;
            
            const signOutBtn = document.getElementById('sign-out-btn');
            if (signOutBtn) signOutBtn.onclick = handleSignOut;
            
            // Shop buttons
            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.getAttribute('data-product-id');
                    state.selectedProduct = state.products.find(p => p.id === productId);
                    state.checkoutStep = 1;
                    renderApp();
                };
            });
            
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.onclick = () => {
                    state.cart.push(state.selectedProduct);
                    state.checkoutStep = 2;
                    renderApp();
                };
            }
            
            const backToShopBtn = document.getElementById('back-to-shop-btn');
            if (backToShopBtn) backToShopBtn.onclick = () => {
                state.selectedProduct = null;
                state.checkoutStep = 0;
                renderApp();
            };
            
            const backToShopBtn2 = document.getElementById('back-to-shop-btn-2');
            if (backToShopBtn2) backToShopBtn2.onclick = () => {
                state.selectedProduct = null;
                state.checkoutStep = 0;
                renderApp();
            };
            
            const continueShoppingBtn = document.getElementById('continue-shopping-btn');
            if (continueShoppingBtn) continueShoppingBtn.onclick = () => {
                state.cart = [];
                state.shippingInfo = { name: '', email: '', address: '' };
                state.selectedProduct = null;
                state.checkoutStep = 0;
                renderApp();
            };

            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                checkoutForm.onsubmit = (e) => {
                    e.preventDefault();
                    state.shippingInfo.name = document.getElementById('shipping-name').value;
                    state.shippingInfo.email = document.getElementById('shipping-email').value;
                    state.shippingInfo.address = document.getElementById('shipping-address').value;
                    state.checkoutStep = 3;
                    renderApp();
                };
            }

            // Admin panel buttons
            const addProductForm = document.getElementById('add-product-form');
            if (addProductForm) {
                addProductForm.onsubmit = handleAddProduct;
            }
            
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.getAttribute('data-product-id');
                    handleDeleteProduct(productId);
                };
            });

            document.querySelectorAll('.dismiss-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.getAttribute('data-product-id');
                    const isAvailable = e.target.getAttribute('data-is-available') === 'true';
                    handleDismissProduct(productId, isAvailable);
                };
            });
        }

        // --- Firebase Handlers ---
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(state.auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(state.auth);
            } catch (error) {
                console.error("Error during sign-out:", error);
            }
        }
        
        async function handleAddProduct(e) {
            e.preventDefault();
            const productsRef = collection(state.db, `artifacts/${appId}/public/data/products`);
            await addDoc(productsRef, {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                imageUrl: document.getElementById('product-image-url').value,
                isAvailable: true,
                createdAt: new Date()
            });
            // Clear form fields after adding
            e.target.reset();
        }

        async function handleDeleteProduct(productId) {
            const productRef = doc(state.db, `artifacts/${appId}/public/data/products`, productId);
            await deleteDoc(productRef);
        }

        async function handleDismissProduct(productId, isAvailable) {
            const productRef = doc(state.db, `artifacts/${appId}/public/data/products`, productId);
            await setDoc(productRef, { isAvailable: !isAvailable }, { merge: true });
        }


        // --- Initialization ---
        function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);

                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        state.user = user;
                    } else {
                        state.user = null;
                    }
                    // Re-render the UI on auth state change
                    renderApp();
                });

                // Initial sign-in attempt
                const signIn = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(state.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(state.auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                    }
                };
                signIn();

                // Set up the Firestore listener for products
                const productsRef = collection(state.db, `artifacts/${appId}/public/data/products`);
                onSnapshot(productsRef, (snapshot) => {
                    state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderApp(); // Re-render the app when products change
                });
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                root.innerHTML = `<div class="p-8 text-center text-red-500">Error: Could not initialize Firebase. Check your console for details.</div>`;
            }
        }
        
        initApp();

    </script>
</body>
</html>
